version: '3.8'

services:
  mongodb:
    image: mongo:latest
    container_name: mongodb-staging
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: MiContraseñaSegura123
      MONGO_INITDB_DATABASE: present
      ENVIRONMENT: staging
    volumes:
      - mongodb_staging_data:/data/db
    networks:
      - app_network_staging
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10sURL base de Axios: https://api.staging.present.attadia.com
index-Cenp-ZVP.js:76 Ambiente de autenticación: {env: 'production', baseUrl: 'https://api.staging.present.attadia.com', mode: 'production', viteApiUrl: 'https://api.present.attadia.com', isStaging: true}
index-Cenp-ZVP.js:76 Configuración: {authPrefix: '/api/auth', apiPrefix: '/api', baseUrl: 'https://api.staging.present.attadia.com', frontendUrl: 'https://staging.present.attadia.com'}
index-Cenp-ZVP.js:481 Ambiente de autenticación: {env: 'production', baseUrl: 'https://api.staging.present.attadia.com', mode: 'production', viteApiUrl: 'https://api.present.attadia.com', isStaging: true}
index-Cenp-ZVP.js:481 Configuración: {authPrefix: '/api/auth', apiPrefix: '/api', baseUrl: 'https://api.staging.present.attadia.com'}
index-Cenp-ZVP.js:76 Usuario autenticado: {id: '67d447fe37943fae4eab5586', nombre: 'Polo Attadía Graña', email: 'polo@poloatt.com', role: 'USER', googleId: '113493925552811554797', …}
index-Cenp-ZVP.js:481 Proyectos con tareas: {docs: Array(1), totalDocs: 1, limit: 10, totalPages: 1, page: 1, …}
tareas:1 Access to XMLHttpRequest at 'https://api.staging.present.attadia.com/tareas/67d62d7037943fae4eab57b9/subtareas' from origin 'https://staging.present.attadia.com' has been blocked by CORS policy: The 'Access-Control-Allow-Origin' header contains multiple values 'https://staging.present.attadia.com, https://staging.present.attadia.com', but only one is allowed.Comprendi l'erroreAI
index-Cenp-ZVP.js:76 Error de conexión: Be {message: 'Network Error', name: 'AxiosError', code: 'ERR_NETWORK', config: {…}, request: XMLHttpRequest, …}
overrideMethod @ hook.js:608
(anonime) @ index-Cenp-ZVP.js:76
Promise.then
_request @ index-Cenp-ZVP.js:76
request @ index-Cenp-ZVP.js:75
(anonime) @ index-Cenp-ZVP.js:76
(anonime) @ index-Cenp-ZVP.js:71
y @ index-Cenp-ZVP.js:481
onChange @ index-Cenp-ZVP.js:481
I @ index-Cenp-ZVP.js:173
g6 @ index-Cenp-ZVP.js:37
x6 @ index-Cenp-ZVP.js:37
y6 @ index-Cenp-ZVP.js:37
pC @ index-Cenp-ZVP.js:37
bP @ index-Cenp-ZVP.js:37
(anonime) @ index-Cenp-ZVP.js:37
Yx @ index-Cenp-ZVP.js:40
W4 @ index-Cenp-ZVP.js:37
ag @ index-Cenp-ZVP.js:37
wx @ index-Cenp-ZVP.js:37
D6 @ index-Cenp-ZVP.js:37Comprendi l'erroreAI
index-Cenp-ZVP.js:481 Error al actualizar subtarea: Error: Error de conexión con el servidor. Por favor, verifica tu conexión a internet.
    at index-Cenp-ZVP.js:76:5915
    at async Is.request (index-Cenp-ZVP.js:75:1968)
    at async y (index-Cenp-ZVP.js:481:338867)
    at Is.request (index-Cenp-ZVP.js:75:2064)
    at async y (index-Cenp-ZVP.js:481:338867)
overrideMethod @ hook.js:608
y @ index-Cenp-ZVP.js:481
await in y
onChange @ index-Cenp-ZVP.js:481
I @ index-Cenp-ZVP.js:173
g6 @ index-Cenp-ZVP.js:37
x6 @ index-Cenp-ZVP.js:37
y6 @ index-Cenp-ZVP.js:37
pC @ index-Cenp-ZVP.js:37
bP @ index-Cenp-ZVP.js:37
(anonime) @ index-Cenp-ZVP.js:37
Yx @ index-Cenp-ZVP.js:40
W4 @ index-Cenp-ZVP.js:37
ag @ index-Cenp-ZVP.js:37
wx @ index-Cenp-ZVP.js:37
D6 @ index-Cenp-ZVP.js:37Comprendi l'erroreAI
index-Cenp-ZVP.js:73 
            
            
           PATCH https://api.staging.present.attadia.com/tareas/67d62d7037943fae4eab57b9/subtareas net::ERR_FAILED 200 (OK)
(anonime) @ index-Cenp-ZVP.js:73
xhr @ index-Cenp-ZVP.js:73
Tw @ index-Cenp-ZVP.js:75
Promise.then
_request @ index-Cenp-ZVP.js:76
request @ index-Cenp-ZVP.js:75
(anonime) @ index-Cenp-ZVP.js:76
(anonime) @ index-Cenp-ZVP.js:71
y @ index-Cenp-ZVP.js:481
onChange @ index-Cenp-ZVP.js:481
I @ index-Cenp-ZVP.js:173
g6 @ index-Cenp-ZVP.js:37
x6 @ index-Cenp-ZVP.js:37
y6 @ index-Cenp-ZVP.js:37
pC @ index-Cenp-ZVP.js:37
bP @ index-Cenp-ZVP.js:37
(anonime) @ index-Cenp-ZVP.js:37
Yx @ index-Cenp-ZVP.js:40
W4 @ index-Cenp-ZVP.js:37
ag @ index-Cenp-ZVP.js:37
wx @ index-Cenp-ZVP.js:37
D6 @ index-Cenp-ZVP.js:37Comprendi l'erroreAI
tareas:1 Access to XMLHttpRequest at 'https://api.staging.present.attadia.com/tareas/67d62d7037943fae4eab57b9/subtareas' from origin 'https://staging.present.attadia.com' has been blocked by CORS policy: The 'Access-Control-Allow-Origin' header contains multiple values 'https://staging.present.attadia.com, https://staging.present.attadia.com', but only one is allowed.Comprendi l'erroreAI
index-Cenp-ZVP.js:76 Error de conexión: Be {message: 'Network Error', name: 'AxiosError', code: 'ERR_NETWORK', config: {…}, request: XMLHttpRequest, …}
overrideMethod @ hook.js:608
(anonime) @ index-Cenp-ZVP.js:76
Promise.then
_request @ index-Cenp-ZVP.js:76
request @ index-Cenp-ZVP.js:75
(anonime) @ index-Cenp-ZVP.js:76
(anonime) @ index-Cenp-ZVP.js:71
y @ index-Cenp-ZVP.js:481
onChange @ index-Cenp-ZVP.js:481
I @ index-Cenp-ZVP.js:173
g6 @ index-Cenp-ZVP.js:37
x6 @ index-Cenp-ZVP.js:37
y6 @ index-Cenp-ZVP.js:37
pC @ index-Cenp-ZVP.js:37
bP @ index-Cenp-ZVP.js:37
(anonime) @ index-Cenp-ZVP.js:37
Yx @ index-Cenp-ZVP.js:40
W4 @ index-Cenp-ZVP.js:37
ag @ index-Cenp-ZVP.js:37
wx @ index-Cenp-ZVP.js:37
D6 @ index-Cenp-ZVP.js:37Comprendi l'erroreAI
index-Cenp-ZVP.js:481 Error al actualizar subtarea: Error: Error de conexión con el servidor. Por favor, verifica tu conexión a internet.
    at index-Cenp-ZVP.js:76:5915
    at async Is.request (index-Cenp-ZVP.js:75:1968)
    at async y (index-Cenp-ZVP.js:481:338867)
    at Is.request (index-Cenp-ZVP.js:75:2064)
    at async y (index-Cenp-ZVP.js:481:338867)
overrideMethod @ hook.js:608
y @ index-Cenp-ZVP.js:481
await in y
onChange @ index-Cenp-ZVP.js:481
I @ index-Cenp-ZVP.js:173
g6 @ index-Cenp-ZVP.js:37
x6 @ index-Cenp-ZVP.js:37
y6 @ index-Cenp-ZVP.js:37
pC @ index-Cenp-ZVP.js:37
bP @ index-Cenp-ZVP.js:37
(anonime) @ index-Cenp-ZVP.js:37
Yx @ index-Cenp-ZVP.js:40
W4 @ index-Cenp-ZVP.js:37
ag @ index-Cenp-ZVP.js:37
wx @ index-Cenp-ZVP.js:37
D6 @ index-Cenp-ZVP.js:37Comprendi l'erroreAI
index-Cenp-ZVP.js:73 
            
            
           PATCH https://api.staging.present.attadia.com/tareas/67d62d7037943fae4eab57b9/subtareas net::ERR_FAILED 200 (OK)
(anonime) @ index-Cenp-ZVP.js:73
xhr @ index-Cenp-ZVP.js:73
Tw @ index-Cenp-ZVP.js:75
Promise.then
_request @ index-Cenp-ZVP.js:76
request @ index-Cenp-ZVP.js:75
(anonime) @ index-Cenp-ZVP.js:76
(anonime) @ index-Cenp-ZVP.js:71
y @ index-Cenp-ZVP.js:481
onChange @ index-Cenp-ZVP.js:481
I @ index-Cenp-ZVP.js:173
g6 @ index-Cenp-ZVP.js:37
x6 @ index-Cenp-ZVP.js:37
y6 @ index-Cenp-ZVP.js:37
pC @ index-Cenp-ZVP.js:37
bP @ index-Cenp-ZVP.js:37
(anonime) @ index-Cenp-ZVP.js:37
Yx @ index-Cenp-ZVP.js:40
W4 @ index-Cenp-ZVP.js:37
ag @ index-Cenp-ZVP.js:37
wx @ index-Cenp-ZVP.js:37
D6 @ index-Cenp-ZVP.js:37Comprendi l'erroreAI
tareas:1 Access to XMLHttpRequest at 'https://api.staging.present.attadia.com/tareas/67d62d7037943fae4eab57b9/subtareas' from origin 'https://staging.present.attadia.com' has been blocked by CORS policy: The 'Access-Control-Allow-Origin' header contains multiple values 'https://staging.present.attadia.com, https://staging.present.attadia.com', but only one is allowed.Comprendi l'erroreAI
index-Cenp-ZVP.js:76 Error de conexión: Be {message: 'Network Error', name: 'AxiosError', code: 'ERR_NETWORK', config: {…}, request: XMLHttpRequest, …}
overrideMethod @ hook.js:608
(anonime) @ index-Cenp-ZVP.js:76
Promise.then
_request @ index-Cenp-ZVP.js:76
request @ index-Cenp-ZVP.js:75
(anonime) @ index-Cenp-ZVP.js:76
(anonime) @ index-Cenp-ZVP.js:71
y @ index-Cenp-ZVP.js:481
onChange @ index-Cenp-ZVP.js:481
I @ index-Cenp-ZVP.js:173
g6 @ index-Cenp-ZVP.js:37
x6 @ index-Cenp-ZVP.js:37
y6 @ index-Cenp-ZVP.js:37
pC @ index-Cenp-ZVP.js:37
bP @ index-Cenp-ZVP.js:37
(anonime) @ index-Cenp-ZVP.js:37
Yx @ index-Cenp-ZVP.js:40
W4 @ index-Cenp-ZVP.js:37
ag @ index-Cenp-ZVP.js:37
wx @ index-Cenp-ZVP.js:37
D6 @ index-Cenp-ZVP.js:37Comprendi l'erroreAI
index-Cenp-ZVP.js:481 Error al actualizar subtarea: Error: Error de conexión con el servidor. Por favor, verifica tu conexión a internet.
    at index-Cenp-ZVP.js:76:5915
    at async Is.request (index-Cenp-ZVP.js:75:1968)
    at async y (index-Cenp-ZVP.js:481:338867)
    at Is.request (index-Cenp-ZVP.js:75:2064)
    at async y (index-Cenp-ZVP.js:481:338867)
overrideMethod @ hook.js:608
y @ index-Cenp-ZVP.js:481
await in y
onChange @ index-Cenp-ZVP.js:481
I @ index-Cenp-ZVP.js:173
g6 @ index-Cenp-ZVP.js:37
x6 @ index-Cenp-ZVP.js:37
y6 @ index-Cenp-ZVP.js:37
pC @ index-Cenp-ZVP.js:37
bP @ index-Cenp-ZVP.js:37
(anonime) @ index-Cenp-ZVP.js:37
Yx @ index-Cenp-ZVP.js:40
W4 @ index-Cenp-ZVP.js:37
ag @ index-Cenp-ZVP.js:37
wx @ index-Cenp-ZVP.js:37
D6 @ index-Cenp-ZVP.js:37Comprendi l'erroreAI
index-Cenp-ZVP.js:73 
            
            
           PATCH https://api.staging.present.attadia.com/tareas/67d62d7037943fae4eab57b9/subtareas net::ERR_FAILED 200 (OK)
      retries: 3
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "mongodb-staging"

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
      args:
        - BUILD_ENV=staging
    image: present/backend:staging
    container_name: backend-staging
    restart: always
    expose:
      - "5000"
    env_file:
      - ./backend/.env.staging
    environment:
      - NODE_ENV=production
      - ENVIRONMENT=staging
      - IS_STAGING=true
      - MONGODB_URI=mongodb://admin:MiContraseñaSegura123@mongodb-staging:27017/present?authSource=admin
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - app_network_staging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "backend-staging"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
      args:
        - BUILD_ENV=staging
    image: present/frontend:staging
    container_name: frontend-staging
    restart: always
    ports:
      - "80:80"
      - "443:443"
    env_file:
      - ./frontend/.env.staging
    environment:
      - NODE_ENV=production
      - ENVIRONMENT=staging
      - VITE_API_URL=https://api.staging.present.attadia.com
      - VITE_FRONTEND_URL=https://staging.present.attadia.com
      - VITE_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - IS_STAGING=true
    volumes:
      - ./nginx/conf.d/staging.conf:/etc/nginx/conf.d/default.conf
      - ./ssl/certbot/conf:/etc/letsencrypt
      - ./ssl/certbot/www:/var/www/certbot
    depends_on:
      - backend
    networks:
      - app_network_staging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "frontend-staging"

  certbot:
    image: certbot/certbot:latest
    container_name: certbot-staging
    volumes:
      - ./ssl/certbot/conf:/etc/letsencrypt
      - ./ssl/certbot/www:/var/www/certbot
    depends_on:
      - frontend
    command: certonly --webroot --webroot-path=/var/www/certbot --email admin@attadia.com --agree-tos --no-eff-email --non-interactive --keep-until-expiring -d staging.present.attadia.com

networks:
  app_network_staging:
    name: present_app_network_staging

volumes:
  mongodb_staging_data:
    name: present_mongodb_staging_data
